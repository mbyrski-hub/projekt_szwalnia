{% extends "base.html" %}
{% block title %}Nowe Zlecenie{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-plus-circle"></i> Nowe Zlecenie</h2>
    
    <div class="form-inline">
        <label for="templateSelector" class="mr-2"><strong>Utwórz z szablonu:</strong></label>
        <select id="templateSelector" class="form-control">
            <option value="">-- Wybierz szablon --</option>
            {% for template in templates %}
            <option value="{{ template.id }}">{{ template.template_name }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<form method="POST" enctype="multipart/form-data" class="mt-4">
    {{ form.hidden_tag() }}

    <div class="row">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h4>Dane Główne Zlecenia</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        {{ form.client_name.label(class="form-label") }}
                        {{ form.client_name(class="form-control", list="clients-list") }}
                        <datalist id="clients-list">
                            {% for client in clients %}<option value="{{ client.name }}">{% endfor %}
                        </datalist>
                    </div>
                    <div class="form-group">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows=4) }}
                    </div>
                    
                    <div class="form-group">
                        <label>Tkaniny</label>
                        <div id="fabrics-list">
                            {% for fabric_form in form.fabrics %}
                            <div class="input-group mb-2 fabric-row">
                                {{ fabric_form.fabric_id(class="form-control") }}
                                <div class="input-group-append">
                                    <button class="btn btn-danger remove-fabric" type="button"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="add-fabric"><i class="fas fa-plus"></i> Dodaj kolejną tkaninę</button>
                    </div>

                    <div class="form-group">
                        {{ form.login_info.label(class="form-label") }}
                        {{ form.login_info(class="form-control", rows=2, placeholder="Opcjonalnie...") }}
                    </div>
                    <div class="form-group">
                        {{ form.deadline.label(class="form-label") }}
                        {{ form.deadline(class="form-control") }}
                    </div>
                    <div class="form-group">
                        {{ form.zlecajacy.label(class="form-label") }}
                        {{ form.zlecajacy(class="form-control") }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h4><i class="fas fa-box-open"></i> Produkty</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="productCategoryFilter">Filtruj produkty po kategorii:</label>
                        <select id="productCategoryFilter" class="form-control form-control-sm">
                            <option value="all">-- Pokaż wszystkie kategorie --</option>
                            {% for category in categories %}<option value="{{ category.id }}">{{ category.name }}</option>{% endfor %}
                        </select>
                    </div>
                    <hr>
                    <div id="products-list">
                        {% for product_form in form.products %}
                        <div class="card mb-3 p-3 product-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {{ product_form.product_name.label() }}
                                    {{ product_form.product_name(class="form-control product-name-input", list="products-datalist") }}
                                    <datalist id="products-datalist">
                                        </datalist>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-danger btn-sm remove-product" title="Usuń produkt"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <div class="variants mt-3">
                                <h5>Rozmiary:</h5>
                                <div class="variant-list">
                                    {% for variant in product_form.variants %}
                                    <div class="form-row variant-row">
                                        <div class="form-group col-md-5">
                                            {{ variant.size(class="form-control", placeholder="Rozmiar") }}
                                        </div>
                                        <div class="form-group col-md-5">
                                            {{ variant.quantity(class="form-control", placeholder="Ilość") }}
                                        </div>
                                        <div class="form-group col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger btn-sm remove-variant" title="Usuń wariant"><i class="fas fa-minus"></i></button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm add-variant"><i class="fas fa-plus"></i> Dodaj kolejny</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-secondary mt-2" id="add-product">
                        <i class="fas fa-plus"></i> Dodaj kolejny produkt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h4><i class="fas fa-paperclip"></i> Załączniki</h4>
                </div>
                <div class="card-body">
                    <input type="file" name="attachments" id="attachments" multiple class="form-control-file">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h4><i class="fas fa-bookmark"></i> Opcje Szablonu</h4>
                </div>
                <div class="card-body">
                    <div class="form-group form-check">
                        {{ form.save_template(class="form-check-input") }}
                        {{ form.save_template.label(class="form-check-label") }}
                    </div>
                    <div class="form-group">
                        {{ form.template_name.label(class="form-label") }}
                        {{ form.template_name(class="form-control", placeholder="Podaj nazwę szablonu") }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4">
        {{ form.submit(class="btn btn-primary btn-lg") }}
    </div>

</form>

<template id="fabric-row-template">
    <div class="input-group mb-2 fabric-row">
        <select class="form-control">
            {% for id, name in fabric_choices %}
            <option value="{{ id }}">{{ name }}</option>
            {% endfor %}
        </select>
        <div class="input-group-append">
            <button class="btn btn-danger remove-fabric" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script>
    // --- ZAKTUALIZOWANY, ROZBUDOWANY SKRYPT ---
    document.addEventListener('DOMContentLoaded', function() {
        const allProductsData = JSON.parse('{{ products_json|safe }}');
        
        const fabricsList = document.getElementById('fabrics-list');
        const fabricTemplate = document.getElementById('fabric-row-template');
        const productsListContainer = document.getElementById('products-list');

        function reindexAll() {
            document.querySelectorAll('#fabrics-list .fabric-row').forEach((row, index) => {
                const select = row.querySelector('select');
                if (select) {
                    select.name = `fabrics-${index}-fabric_id`;
                }
            });
            document.querySelectorAll('#products-list .product-card').forEach((card, productIndex) => {
                const productNameInput = card.querySelector('input[name*="product_name"]');
                if (productNameInput) {
                    productNameInput.name = `products-${productIndex}-product_name`;
                }
                card.querySelectorAll('.variant-row').forEach((row, variantIndex) => {
                    const sizeInput = row.querySelector('input[name*="size"]');
                    const quantityInput = row.querySelector('input[name*="quantity"]');
                    if(sizeInput) sizeInput.name = `products-${productIndex}-variants-${variantIndex}-size`;
                    if(quantityInput) quantityInput.name = `products-${productIndex}-variants-${variantIndex}-quantity`;
                });
            });
        }

        function addFabricRow(fabricId = null) {
            const newRow = fabricTemplate.content.cloneNode(true);
            if (fabricId) {
                newRow.querySelector('select').value = fabricId;
            }
            fabricsList.appendChild(newRow);
            reindexAll();
        }

        function updateOrderFabrics() {
            const requiredFabrics = new Set();
            // Zbierz wszystkie tkaniny ze wszystkich wybranych produktów
            document.querySelectorAll('.product-name-input').forEach(input => {
                const productName = input.value.trim().toUpperCase();
                const productData = allProductsData.find(p => p.name.toUpperCase() === productName);
                if (productData && productData.fabrics) {
                    productData.fabrics.forEach(fabricId => requiredFabrics.add(fabricId));
                }
            });

            // Zbierz tkaniny już dodane do formularza
            const currentFabrics = new Set();
            document.querySelectorAll('#fabrics-list select').forEach(select => {
                currentFabrics.add(parseInt(select.value, 10));
            });

            // Dodaj brakujące tkaniny
            requiredFabrics.forEach(fabricId => {
                if (!currentFabrics.has(fabricId)) {
                    addFabricRow(fabricId);
                }
            });
        }

        // Delegacja zdarzeń dla dynamicznie dodawanych pól
        productsListContainer.addEventListener('input', e => {
            if (e.target && e.target.classList.contains('product-name-input')) {
                updateOrderFabrics();
            }
        });
        
        productsListContainer.addEventListener('click', e => {
            const addVariantBtn = e.target.closest('.add-variant');
            if(addVariantBtn) {
                const productCard = addVariantBtn.closest('.product-card');
                const variantList = productCard.querySelector('.variant-list');
                const firstVariant = variantList.querySelector('.variant-row');
                if (!firstVariant) return;
                const newVariant = firstVariant.cloneNode(true);
                newVariant.querySelectorAll('input').forEach(input => input.value = '');
                variantList.appendChild(newVariant);
                reindexAll();
            }
            const removeVariantBtn = e.target.closest('.remove-variant');
            if(removeVariantBtn) {
                const variantRow = removeVariantBtn.closest('.variant-row');
                const variantList = variantRow.parentNode;
                if(variantList.children.length > 1) {
                    variantRow.remove();
                    reindexAll();
                } else {
                    alert("Nie można usunąć ostatniego wariantu.");
                }
            }
            const removeProductBtn = e.target.closest('.remove-product');
            if(removeProductBtn) {
                if(document.querySelectorAll('.product-card').length > 1) {
                    removeProductBtn.closest('.product-card').remove();
                    reindexAll();
                    updateOrderFabrics(); // Zaktualizuj tkaniny po usunięciu produktu
                } else {
                    alert("Nie można usunąć ostatniego produktu.");
                }
            }
        });

        document.getElementById('add-fabric').addEventListener('click', () => addFabricRow());
        fabricsList.addEventListener('click', e => {
            if (e.target.closest('.remove-fabric')) {
                if(fabricsList.children.length > 1){
                    e.target.closest('.fabric-row').remove();
                    reindexAll();
                } else {
                     alert("Musi pozostać co najmniej jedna tkanina.");
                }
            }
        });

        document.getElementById('add-product').addEventListener('click', function(){
            const firstProductCard = productsListContainer.querySelector('.product-card');
            if (!firstProductCard) return;
            const newProduct = firstProductCard.cloneNode(true);
            newProduct.querySelectorAll('input').forEach(input => input.value = '');
            productsListContainer.appendChild(newProduct);
            reindexAll();
        });

        // Logika filtrowania i szablonów (bez zmian)
        const categoryFilter = document.getElementById('productCategoryFilter');
        const productDatalist = document.getElementById('products-datalist');
        function updateProductDatalist(selectedCategoryId) {
            productDatalist.innerHTML = '';
            const filteredProducts = allProductsData.filter(product => {
                return selectedCategoryId === 'all' || product.category_id == selectedCategoryId;
            });
            filteredProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                productDatalist.appendChild(option);
            });
        }
        categoryFilter.addEventListener('change', function() { updateProductDatalist(this.value); });
        updateProductDatalist('all');
        
        const templateSelector = document.getElementById('templateSelector');
        templateSelector.addEventListener('change', function() {
            const templateId = this.value;
            if (templateId) {
                window.location.href = `{{ url_for('new_order') }}?template_id=${templateId}`;
            }
        });
        const urlParams = new URLSearchParams(window.location.search);
        const loadedTemplateId = urlParams.get('template_id');
        if (loadedTemplateId) {
            templateSelector.value = loadedTemplateId;
        }

        reindexAll();
    });
</script>
{% endblock %}