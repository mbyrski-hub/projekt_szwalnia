<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Szwalnia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="manifest" href="{{ url_for('static', filename='mobile_assets/manifest_szwalnia.json') }}">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f4f4f8; color: #333; }
        .container { padding: 10px; }
        .header { background-color: #28a745; color: white; padding: 15px; text-align: center; font-size: 1.5em; position: sticky; top: 0; z-index: 1000; }
        h2 { border-bottom: 2px solid #28a745; padding-bottom: 10px; color: #28a745; margin-top: 20px; font-size: 1.2em;}
        .order-list { display: flex; flex-direction: column; gap: 15px; min-height: 100px; padding: 10px; border-radius: 8px; background-color: #e9ecef; }
        
        #unassigned-list {
            flex-direction: row; flex-wrap: wrap; gap: 2%; row-gap: 15px; align-content: flex-start;
        }
        .order-card {
            background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer; border-left: 5px solid #6c757d; flex-basis: 49%; box-sizing: border-box; position: relative;
        }
        .order-card.draggable { cursor: grab; }
        .order-card.dragging { opacity: 0.5; }
        .order-card-header { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .order-card-client { font-size: 0.9em; color: #555; }
        .drop-zone { border: 2px dashed #ccc; margin-top: 15px; border-radius: 8px;}
        .drop-zone.drag-over { background-color: #d4edda; border-color: #28a745; }
        .team-title { background-color: #28a745; color: white; padding: 10px; border-radius: 5px 5px 0 0; margin: 0; font-size: 1.2em;}
        .loader { text-align: center; padding: 20px; font-size: 1.2em; }
        #refresh-btn { position: fixed; bottom: 20px; right: 20px; background-color: #28a745; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001;}

        .split-icon { position: absolute; top: 10px; right: 10px; font-size: 1.4em; color: #007bff; cursor: pointer; padding: 5px; }
        .split-icon:hover { color: #0056b3; }

        #zrealizowane-zone .team-title { background-color: #343a40; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 25% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #modal-details ul { list-style-type: none; padding: 0; }
        #modal-details li { background: #eee; padding: 5px; margin-bottom: 3px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">Szwalnia</div>
    <div class="container">
        <h2>Do przypisania</h2>
        <div class="order-list" id="unassigned-list"></div>

        <div class="drop-zone" id="zespol-1-zone">
            <h2 class="team-title">Zespół 1</h2>
            <div class="order-list" id="zespol-1-list"></div>
        </div>
        <div class="drop-zone" id="zespol-2-zone">
            <h2 class="team-title">Zespół 2</h2>
            <div class="order-list" id="zespol-2-list"></div>
        </div>
        <div class="drop-zone" id="zrealizowane-zone">
            <h2 class="team-title">Zrealizowane</h2>
            <div class="order-list" id="zrealizowane-list"></div>
        </div>
    </div>
    <button id="refresh-btn"><i class="fas fa-sync-alt"></i></button>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-title">Szczegóły zlecenia</h3>
            <div id="modal-details"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lists = {
                'unassigned-list': document.getElementById('unassigned-list'),
                'zespol-1-list': document.getElementById('zespol-1-list'),
                'zespol-2-list': document.getElementById('zespol-2-list'),
                'zrealizowane-list': document.getElementById('zrealizowane-list')
            };
            const zones = {
                'zespol-1': document.getElementById('zespol-1-zone'),
                'zespol-2': document.getElementById('zespol-2-zone'),
                'zrealizowane': document.getElementById('zrealizowane-zone'),
                'unassigned': document.getElementById('unassigned-list')
            };
            let draggedItem = null;

            const modal = document.getElementById('details-modal');
            const modalDetails = document.getElementById('modal-details');
            const closeModal = document.querySelector('.close-btn');
            closeModal.onclick = () => { modal.style.display = 'none'; };
            window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };
            
            async function showOrderDetails(orderId) {
                modalDetails.innerHTML = '<div class="loader">Ładowanie...</div>';
                modal.style.display = 'block';
                const response = await fetch(`/api/order/${orderId}/details`);
                const data = await response.json();
                let productsHtml = '<h4>Produkty:</h4><ul>';
                data.products.forEach(p => {
                    productsHtml += `<li><strong>${p.name}</strong> - ${p.size}: ${p.quantity} szt.</li>`;
                });
                productsHtml += '</ul>';
                modalDetails.innerHTML = `
                    <p><strong>Klient:</strong> ${data.client_name}</p>
                    <p><strong>Opis:</strong> ${data.description || 'Brak'}</p>
                    ${productsHtml}
                `;
            }

            async function fetchOrders() {
                lists['unassigned-list'].innerHTML = '<div class="loader">Ładowanie zleceń...</div>';
                const response = await fetch('/api/szwalnia/orders');
                const orders = await response.json();
                renderOrders(orders);
            }

            function renderOrders(orders) {
                Object.values(lists).forEach(list => list.innerHTML = '');

                orders.forEach(order => {
                    const assignedTeam = order.assigned_team;
                    
                    // --- ZMIANA W LOGICE WYŚWIETLANIA ---
                    if (assignedTeam === 'OBA') {
                        // Jeśli zlecenie jest podzielone, wyświetl kartę tylko dla zespołów, które jeszcze go nie ukończyły
                        if (!order.team1_completed) {
                            const card1 = createCard(order, 'zespol-1', true);
                            lists['zespol-1-list'].appendChild(card1);
                        }
                        if (!order.team2_completed) {
                            const card2 = createCard(order, 'zespol-2', true);
                            lists['zespol-2-list'].appendChild(card2);
                        }
                    } else if (assignedTeam) {
                        // Standardowe przypisanie do jednego zespołu
                        const card = createCard(order, assignedTeam, true);
                        lists[`${assignedTeam}-list`].appendChild(card);
                    } else {
                        // Zlecenia nieprzypisane
                        const card = createCard(order, null, true, true);
                        lists['unassigned-list'].appendChild(card);
                    }
                    // --- KONIEC ZMIANY ---
                });
                addEventListeners();
            }

            function createCard(order, teamContext = null, draggable = false, addSplitIcon = false) {
                const card = document.createElement('div');
                card.className = 'order-card';
                if (draggable) card.classList.add('draggable');
                card.draggable = draggable;
                card.dataset.orderId = order.id;
                if (teamContext) card.dataset.teamContext = teamContext;
                
                card.innerHTML = `
                    <div class="order-card-header">${order.order_code}</div>
                    <div class="order-card-client">${order.client_name}</div>
                    ${addSplitIcon ? `<i class="fas fa-arrows-alt-h split-icon" title="Przypisz do obu zespołów"></i>` : ''}
                `;
                return card;
            }

            function addEventListeners() {
                document.querySelectorAll('.order-card').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.classList.contains('split-icon')) return;
                        showOrderDetails(item.dataset.orderId);
                    });

                    if (item.draggable) {
                        item.addEventListener('dragstart', (e) => {
                            if (e.target.classList.contains('split-icon')) { e.preventDefault(); return; }
                            draggedItem = item;
                            setTimeout(() => item.classList.add('dragging'), 0);
                        });
                        item.addEventListener('dragend', () => {
                            if (draggedItem) draggedItem.classList.remove('dragging');
                            draggedItem = null;
                        });
                    }
                });

                document.querySelectorAll('.split-icon').forEach(icon => {
                    icon.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const card = e.target.closest('.order-card');
                        const orderId = card.dataset.orderId;
                        if (confirm(`Czy na pewno chcesz przypisać zlecenie do OBU zespołów?`)) {
                            await assignTeam(orderId, 'OBA');
                        }
                    });
                });
            }

            Object.entries(zones).forEach(([zoneId, zone]) => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', async e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    if (!draggedItem) return;

                    const orderId = draggedItem.dataset.orderId;
                    const list = zone.querySelector('.order-list');

                    if (zoneId === 'zrealizowane') {
                        const teamContext = draggedItem.dataset.teamContext;
                        await completeOrder(orderId, teamContext);
                    } else {
                        const team = zoneId === 'unassigned' ? null : zoneId;
                        list.appendChild(draggedItem);
                        await assignTeam(orderId, team);
                    }
                });
            });

            async function assignTeam(orderId, team) {
                await fetch(`/api/order/${orderId}/assign_team`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team: team })
                });
                await fetchOrders();
            }

            async function completeOrder(orderId, teamContext) {
                await fetch(`/api/order/${orderId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed_by: teamContext })
                });
                await fetchOrders();
            }
            
            document.getElementById('refresh-btn').addEventListener('click', fetchOrders);
            fetchOrders();
        });
    </script>
</body>
</html>