<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Szwalnia</title>
    <link rel="manifest" href="{{ url_for('static', filename='mobile_assets/manifest_szwalnia.json') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; color: #343a40; }
        .container-fluid { padding-left: 10px; padding-right: 10px; }
        h3, h4 { font-weight: 600; color: #495057; }
        h3 { margin-bottom: 1.5rem; }
        h4 { font-size: 1.2rem; margin-bottom: 1rem; display: flex; align-items: center; }
        h4 i { margin-right: 8px; color: #6c757d; }
        h5 { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        hr { border-top: 1px solid #e9ecef; margin: 1.5rem 0; }
        .kanban-section { padding: 1rem; margin-bottom: 1.5rem; }
        
        .team-column { border-radius: 8px; padding: 0.75rem; min-height: 150px; }
        .kanban-cards { min-height: 100px; }

        .kanban-card {
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            cursor: grab;
            position: relative;
        }
        .kanban-card-title { font-weight: 700; color: #343a40; font-size: 0.95rem; }
        .kanban-card-client { font-size: 0.85rem; color: #6c757d; }
        .kanban-card-split { position: absolute; top: 8px; right: 8px; color: #007bff; }

        #unassigned.kanban-cards:empty::after { content: "Brak nowych zleceń do przydzielenia."; display: block; text-align: center; padding: 20px; color: #6c757d; font-style: italic; }
        .team-column .kanban-cards:empty::after { content: "Brak zleceń."; display: block; text-align: center; padding: 20px; color: #6c757d; font-style: italic; opacity: 0.7; }

        /* Kolory dla zespołów i ukończonych */
        #zespol-1-col .team-column { background-color: #e3f2fd; }
        #zespol-2-col .team-column { background-color: #e6ffed; }
        #zrealizowane-col .team-column { background-color: #e9ecef; border-style: dashed; }
    </style>
</head>
<body>
<div class="container-fluid pt-3">
    <h3 class="px-2">Szwalnia</h3>

    <div class="kanban-section">
        <h4><i class="fas fa-inbox"></i> Do przydzielenia (Skrojone)</h4>
        <div class="kanban-cards" id="unassigned"></div>
    </div>
    <hr>

    <div class="kanban-section">
        <h4><i class="fas fa-users"></i> Zespoły</h4>
        <div class="row">
            <div class="col-6 mb-3" id="zespol-1-col">
                <div class="team-column">
                    <h5>Zespół 1</h5>
                    <div class="kanban-cards" id="zespol-1"></div>
                </div>
            </div>
            <div class="col-6 mb-3" id="zespol-2-col">
                <div class="team-column">
                    <h5>Zespół 2</h5>
                    <div class="kanban-cards" id="zespol-2"></div>
                </div>
            </div>
        </div>
    </div>
    <hr>

    <div class="kanban-section">
        <h4><i class="fas fa-check-circle"></i> Ukończone</h4>
        <div id="zrealizowane-col">
            <div class="team-column">
                <div class="kanban-cards" id="zrealizowane"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let longPressTimer;
    const longPressDuration = 500;

    function handleLongPress(orderId, currentTeam) {
        if (currentTeam !== 'OBA') {
            if (confirm(`Czy chcesz przypisać to zlecenie do OBU zespołów?`)) {
                assignTeam(orderId, 'OBA');
            }
        }
    }

    function assignTeam(orderId, team) {
        fetch(`/api/order/${orderId}/assign_team`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: team })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success (assignTeam):', data);
            fetchAndRenderOrders();
        })
        .catch((error) => console.error('Error:', error));
    }
    
    function createCard(order, targetColumn) {
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.dataset.orderId = order.id;

        let splitIcon = '';
        if (order.assigned_team === 'OBA') {
            splitIcon = `<i class="fas fa-users kanban-card-split" title="Zlecenie podzielone"></i>`;
        }

        card.innerHTML = `
            <div class="kanban-card-title">${order.order_code}</div>
            <div class="kanban-card-client">${order.client_name}</div>
            ${splitIcon}
        `;

        // Logika długiego przytrzymania
        card.addEventListener('mousedown', () => longPressTimer = setTimeout(() => handleLongPress(order.id, order.assigned_team), longPressDuration));
        card.addEventListener('mouseup', () => clearTimeout(longPressTimer));
        card.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        card.addEventListener('touchstart', () => longPressTimer = setTimeout(() => handleLongPress(order.id, order.assigned_team), longPressDuration));
        card.addEventListener('touchend', () => clearTimeout(longPressTimer));
        
        targetColumn.appendChild(card);
    }

    function fetchAndRenderOrders() {
        fetch('/api/szwalnia/orders')
            .then(response => response.json())
            .then(orders => {
                document.querySelectorAll('.kanban-cards').forEach(col => col.innerHTML = '');
                orders.forEach(order => {
                    if ((order.assigned_team === 'zespol-1' || order.assigned_team === 'OBA') && !order.team1_completed) {
                        createCard(order, document.getElementById('zespol-1'));
                    }
                    if ((order.assigned_team === 'zespol-2' || order.assigned_team === 'OBA') && !order.team2_completed) {
                        createCard(order, document.getElementById('zespol-2'));
                    }
                    if (!order.assigned_team) {
                        createCard(order, document.getElementById('unassigned'));
                    }
                });
            });
    }

    // Inicjalizacja Drag-and-Drop
    ['unassigned', 'zespol-1', 'zespol-2', 'zrealizowane'].forEach(zoneId => {
        const columnEl = document.getElementById(zoneId);
        if (!columnEl) return;
        new Sortable(columnEl, {
            group: 'szwalnia',
            animation: 150,
            onEnd: function (evt) {
                const orderId = evt.item.dataset.id;
                const newZoneId = evt.to.id;
                const sourceZoneId = evt.from.id;

                if (newZoneId === 'zrealizowane') {
                    if (confirm('Oznaczyć jako zrealizowane?')) {
                        fetch(`/api/order/${orderId}/complete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ completed_by: sourceZoneId })
                        }).then(() => fetchAndRenderOrders());
                    } else {
                        // Anuluj przeciągnięcie, jeśli użytkownik kliknie "Anuluj"
                        evt.from.appendChild(evt.item);
                    }
                } else {
                    const teamToSend = newZoneId === 'unassigned' ? null : newZoneId;
                    assignTeam(orderId, teamToSend);
                }
            }
        });
    });

    fetchAndRenderOrders();
});
</script>
</body>
</html>