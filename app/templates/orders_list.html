{% extends "base.html" %}
{% block head %}
<style>
    /* Odstęp między sekcjami akordeonu */
    #accordion .card {
        margin-bottom: 1rem;
        border: none; /* Usuwamy domyślne obramowanie karty */
    }

    /* Pastelowe tła i cienie dla nagłówków */
    .header-in-progress { 
        background-color: #FFF9E6; /* Delikatny żółty */
        box-shadow: 0 4px 15px -5px rgba(255, 193, 7, 0.5);
    }
    .header-new { 
        background-color: #E6F0FF; /* Delikatny niebieski */
        box-shadow: 0 4px 15px -5px rgba(0, 123, 255, 0.4);
    }
    .header-completed { 
        background-color: #E6F9EE; /* Delikatny zielony */
        box-shadow: 0 4px 15px -5px rgba(40, 167, 69, 0.5);
    }

    /* Style dla przycisków w nagłówkach - ciemniejszy odcień koloru */
    .header-in-progress .btn-link { color: #c89400; }
    .header-new .btn-link { color: #004085; }
    .header-completed .btn-link { color: #155724; }

    /* Kolorowanie wierszy w tabelach */
    .status-w-realizacji { background-color: rgba(255, 243, 205, 0.5) !important; }
    .status-nowe { background-color: rgba(207, 226, 255, 0.5) !important; }
    .status-zrealizowane { background-color: rgba(209, 231, 221, 0.5) !important; }

    /* Jaśniejszy i delikatniejszy kolor dla nagłówka tabeli */
    .table thead.thead-dark th {
        background-color: #f1f3f5; /* Bardzo jasny, neutralny szary */
        color: #495057;          /* Ciemniejszy tekst dla dobrego kontrastu */
        border-color: #ffffff;    /* Dopasowany, jasny kolor ramki */
    }

/* Style dla animowanego przycisku "+" */
    .btn-plus-animated {
        /* Wymiary i kształt */
        width: 60px;
        height: 60px;
        border-radius: 50%;

        /* Wygląd i animacja */
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        transition: all 0.3s ease-in-out;
        animation: pulse 2s infinite;

        /* Idealne centrowanie dla ikony */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    /* ### POCZĄTEK ZMIANY (rozmiar ikony) ### */
    .btn-plus-animated .fas {
        font-size: 1.8rem; /* Dopasowany rozmiar ikony */
        color: white;
    }
    /* ### KONIEC ZMIANY ### */

    /* Efekt po najechaniu myszką */
    .btn-plus-animated:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        animation-play-state: paused;
    }

    /* Definicja animacji pulsowania */
    @keyframes pulse {
        0% {
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        50% {
            box-shadow: 0 4px 25px rgba(40, 167, 69, 0.7);
        }
        100% {
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
    }


</style>
{% endblock %}
{% block title %}Lista Zleceń{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-list"></i> Lista Zleceń</h2>
    <a href="{{ url_for('new_order') }}" class="btn btn-success btn-lg btn-plus-animated">
        <i class="fas fa-plus"></i>
    </a>
    </div>
<form method="GET" class="form-inline mb-3">
    </form>

<form method="GET" class="form-inline mb-3">
    <select name="client" class="form-control mr-2">
        <option value="">Wszyscy klienci</option>
        {% for client in clients %}<option value="{{ client.name }}" {% if request.args.get('client','').upper() == client.name.upper() %}selected{% endif %}>{{ client.name }}</option>{% endfor %}
    </select>
    <select name="status" class="form-control mr-2">
        <option value="">Wszystkie statusy</option>
        <option value="NOWE" {% if request.args.get('status') == 'NOWE' %}selected{% endif %}>NOWE</option>
        <option value="W REALIZACJI" {% if request.args.get('status') == 'W REALIZACJI' %}selected{% endif %}>W REALIZACJI</option>
        <option value="ZREALIZOWANE" {% if request.args.get('status') == 'ZREALIZOWANE' %}selected{% endif %}>ZREALIZOWANE</option>
    </select>
    <select name="year" class="form-control mr-2">
        <option value="">Wszystkie lata</option>
        {% for y in years %}<option value="{{ y }}" {% if request.args.get('year') == y|string %}selected{% endif %}>{{ y }}</option>{% endfor %}
    </select>
    <select name="month" class="form-control mr-2">
        <option value="">Wszystkie miesiące</option>
        {% for m in range(1, 13) %}<option value="{{ m }}" {% if request.args.get('month') == m|string %}selected{% endif %}>{{ m }}</option>{% endfor %}
    </select>
    <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Filtruj</button>
</form>

{% macro render_orders_table(orders) %}
<div class="table-responsive p-0 m-0">
    <table class="table table-striped table-hover m-0">
        <thead class="thead-dark">
            <tr>
                <th>Nr zlecenia</th>
                <th>Klient</th>
                <th>Data utworzenia</th>
                <th>Data Szycia</th>
                <th>Status</th>
                <th>Zmiana stanu</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr class="order-row status-{{ order.status|lower|replace(' ', '-') }}" data-order-id="{{ order.id }}" style="cursor: pointer;">
                <td data-label="Nr zlecenia:">{{ order.order_code }}</td>
                <td data-label="Klient:">{{ order.client.name }}</td>
                <td data-label="Data:">{{ order.created_at | to_local_time }}</td>
<td data-label="Data Szycia:">
    {% if order.status == "W REALIZACJI" and order.sewing_started_at %}
        <strong>Start:</strong> {{ order.sewing_started_at | to_local_time }}
    {% elif order.status == "ZREALIZOWANE" and order.sewing_finished_at %}
        <strong>Koniec:</strong> {{ order.sewing_finished_at | to_local_time }}
    {% endif %}
</td>
                </td>
                <td data-label="Status:" class="status-cell">{{ order.status }}</td>
                <td data-label="Zmiana stanu:" class="change-status-cell">
                    {% if order.status == "NOWE" %}
                    <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" class="update-status-form d-inline">
                        <input type="hidden" name="status" value="W REALIZACJI"><button type="submit" class="btn btn-sm btn-warning"><i class="fas fa-play"></i></button>
                    </form>
                    <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" class="update-status-form d-inline">
                        <input type="hidden" name="status" value="ZREALIZOWANE"><button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check"></i></button>
                    </form>
                    {% elif order.status == "W REALIZACJI" %}
                    <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" class="update-status-form d-inline">
                        <input type="hidden" name="status" value="ZREALIZOWANE"><button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check"></i></button>
                    </form>
                    {% elif order.status == "ZREALIZOWANE" %}
                    <a href="{{ url_for('edit_material_usage', order_id=order.id) }}" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i> Edytuj zużycie</a>
                    {% endif %}
                </td>
                <td data-label="Akcje:">
                    <a href="{{ url_for('order_pdf', order_id=order.id) }}" class="btn btn-sm btn-secondary"><i class="fas fa-file-pdf"></i></a>
                    <a href="{{ url_for('order_print', order_id=order.id) }}" class="btn btn-sm btn-info"><i class="fas fa-print"></i></a>
                    <form method="POST" action="{{ url_for('delete_order', order_id=order.id) }}" class="d-inline" onsubmit="return confirm('Czy na pewno usunąć?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            <tr class="order-details" id="details-{{ order.id }}" style="display: none;">
                <td colspan="7">
                    <strong>Opis:</strong> {{ order.description }}<br>
                    <strong>Zlecający:</strong> {{ order.zlecajacy }}<br>
                    <strong>Logowanie:</strong> {{ order.login_info or 'Brak' }}<br>
                    <strong>Tkanina:</strong> {{ order.fabric.name if order.fabric else 'Brak' }}<br>
                    
                    <strong>Produkty:</strong>
                    <ul style="list-style-type: none; padding-left: 0;">
                    {% for product_name, items in order.order_items|groupby('product.name') %}
                        <li style="margin-top: 5px;">
                            <strong>{{ product_name }}:</strong>
                            <ul style="padding-left: 20px; list-style-type: circle;">
                            {% for item in items %}
                                <li>{{ item.size }} - {{ item.quantity }} szt.</li>
                            {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                    </ul>

                    {% if order.materials_used %}
                        <br>
                        <strong>Rzeczywiste zużycie materiałów:</strong>
                        <ul>
                            {% for material in order.materials_used %}
                            <li>{{ material.material_name }} – {{ material.quantity }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <br>
                        <strong>Planowane zużycie materiałów:</strong>
                        {% if order.planned_materials %}
                        <ul>
                            {% for item in order.planned_materials %}
                                <li>{{ item.name }}: {{ item.quantity }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                            <p style="margin-left: 20px;">Brak zdefiniowanych materiałów dla produktów w tym zleceniu.</p>
                        {% endif %}
                    {% endif %}
                    
                    <strong>Szacowany koszt zlecenia:</strong>
                    <ul style="padding-left: 20px; list-style-type: circle;">
                        <li>Koszt tkanin: {{ "%.2f"|format(order.cost_details.fabric_cost) }} zł</li>
                        <li>Koszt materiałów: {{ "%.2f"|format(order.cost_details.material_cost) }} zł</li>
                        <li>Koszt produkcji: {{ "%.2f"|format(order.cost_details.production_cost) }} zł</li>
                        <li style="margin-top: 5px;"><strong>RAZEM: {{ "%.2f"|format(order.cost_details.total_cost) }} zł</strong></li>
                    </ul>
                    </td>
            

            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

<div id="accordion">
    <div class="card">
        <div class="card-header header-in-progress" id="headingInProgress">
            <h5 class="mb-0">
                <button class="btn btn-link font-weight-bold" data-toggle="collapse" data-target="#collapseInProgress" aria-expanded="true" aria-controls="collapseInProgress">
                    W REALIZACJI <span class="badge badge-dark">{{ in_progress_orders|length }}</span>
                </button>
            </h5>
        </div>
        <div id="collapseInProgress" class="collapse show" aria-labelledby="headingInProgress">
            <div class="card-body p-0">
                {{ render_orders_table(in_progress_orders) }}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header header-new" id="headingNew">
            <h5 class="mb-0">
                <button class="btn btn-link font-weight-bold" data-toggle="collapse" data-target="#collapseNew" aria-expanded="true" aria-controls="collapseNew">
                    NOWE <span class="badge badge-dark">{{ new_orders|length }}</span>
                </button>
            </h5>
        </div>
        <div id="collapseNew" class="collapse show" aria-labelledby="headingNew">
            <div class="card-body p-0">
                {{ render_orders_table(new_orders) }}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header header-completed" id="headingCompleted">
            <h5 class="mb-0">
                <button class="btn btn-link font-weight-bold collapsed" data-toggle="collapse" data-target="#collapseCompleted" aria-expanded="false" aria-controls="collapseCompleted">
                    ZREALIZOWANE <span class="badge badge-dark">{{ completed_orders|length }}</span>
                </button>
            </h5>
        </div>
        <div id="collapseCompleted" class="collapse" aria-labelledby="headingCompleted">
            <div class="card-body p-0">
                {{ render_orders_table(completed_orders) }}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 1. Rozwijanie/zwijanie szczegółów zamówienia po kliknięciu w wiersz
    document.querySelectorAll('.order-row').forEach(function(row) {
        row.addEventListener('click', function(e) {
            // Ignoruj kliknięcia w przyciski i linki wewnątrz wiersza
            if(e.target.closest('form') || e.target.closest('a') || e.target.closest('button')) return;
            
            var orderId = this.getAttribute('data-order-id');
            var detailsRow = document.getElementById('details-' + orderId);
            detailsRow.style.display = (detailsRow.style.display === 'none' || detailsRow.style.display === '') ? 'table-row' : 'none';
        });
    });

    // 2. Uproszczona funkcja do obsługi AJAX zmiany statusu
    function setupAjaxStatusChange(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Zatrzymaj domyślną akcję formularza
            var url = form.action;
            var formData = new FormData(form);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-with': 'XMLHttpRequest'
                }
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Odpowiedź serwera nie jest poprawna.');
                }
                return response.json();
            })
            .then(function(data) {
                if(data.success) {
                    // Najprostsze i najpewniejsze rozwiązanie: przeładuj stronę.
                    // To gwarantuje, że zlecenie przeniesie się do właściwej sekcji akordeonu.
                    location.reload();
                } else {
                    alert("Wystąpił błąd podczas zmiany statusu.");
                }
            })
            .catch(function(err) {
                console.error("Błąd zmiany statusu:", err);
                alert("Wystąpił krytyczny błąd. Sprawdź konsolę deweloperską (F12).");
            });
        });
    }

    // 3. Podpięcie obsługi AJAX do wszystkich formularzy zmiany statusu na stronie
    document.querySelectorAll('.update-status-form').forEach(setupAjaxStatusChange);
</script>
{% endblock %}