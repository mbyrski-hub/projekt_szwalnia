{% extends "base.html" %}
{% block title %}Szczegóły Zlecenia{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center">
    <h2>Zlecenie #{{ order.id }}</h2>
    <a href="{{ url_for('order_pdf', order_id=order.id) }}" class="btn btn-secondary"><i class="fas fa-file-pdf"></i> Pobierz PDF</a>
</div>

<div class="row mt-4">
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-info-circle"></i> Dane Główne</h4>
            </div>
            <div class="card-body">
                <p><strong>Kod zlecenia:</strong> {{ order.order_code }}</p>
                <p><strong>Klient:</strong> {{ order.client.name }}</p>
                <p><strong>Termin:</strong> {{ order.deadline.strftime('%Y-%m-%d') }}</p>
                <p><strong>Opis:</strong> {{ order.description }}</p>
                
                <h4>Tkaniny</h4>
                <ul>
                    {% for order_fabric in order.fabrics %}
                        <li>{{ order_fabric.fabric.name }}</li>
                    {% else %}
                        <li>Brak przypisanych tkanin.</li>
                    {% endfor %}
                </ul>

                <h4>Załączniki</h4>
                <ul>
                    {% for attachment in order.attachments %}
                        <li><a href="{{ url_for('uploaded_file', filename=attachment.filename) }}">{{ attachment.filename }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h4><i class="fas fa-ruler"></i> Zużycie Materiałów</h4>
            </div>
            <div class="card-body">
                {% if order.materials_used %}
                    <h5>Rzeczywiste zużycie:</h5>
                    <ul>
                        {% for usage in order.materials_used %}
                            <li>{{ usage.material_name }} - {{ usage.quantity }}</li>
                        {% endfor %}
                    </ul>
                {% elif material_summary %}
                    <h5>Planowane zużycie:</h5>
                    <ul>
                        {% for item in material_summary %}
                            <li>{{ item.name }}: {{ item.quantity }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Brak zdefiniowanych materiałów dla tego zlecenia.</p>
                {% endif %}
            </div>
        </div>
        </div>
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-calendar-alt"></i> Historia Produkcji</h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-6">Rozpoczęcie krojenia:</dt>
                    <dd class="col-sm-6">{{ order.cutting_started_at | to_local_time if order.cutting_started_at else '---' }}</dd>
                    
                    <dt class="col-sm-6">Zakończenie krojenia:</dt>
                    <dd class="col-sm-6">{{ order.cutting_finished_at | to_local_time if order.cutting_finished_at else '---' }}</dd>
                    
                    <dt class="col-sm-6">Rozpoczęcie szycia:</dt>
                    <dd class="col-sm-6">{{ order.sewing_started_at | to_local_time if order.sewing_started_at else '---' }}</dd>
                    
                    <dt class="col-sm-6">Zakończenie szycia:</dt>
                    <dd class="col-sm-6">{{ order.sewing_finished_at | to_local_time if order.sewing_finished_at else '---' }}</dd>
                </dl>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-boxes"></i> Produkty w zleceniu</h4>
            </div>
            <div class="card-body">
                 <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Rozmiar</th>
                            <th>Ilość</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.order_items %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.size }}</td>
                            <td>{{ item.quantity }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-dollar-sign"></i> Szacowany Koszt Zlecenia</h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-7">Koszt tkanin:</dt>
                    <dd class="col-sm-5 text-right">{{ "%.2f"|format(cost_details.fabric_cost) }} zł</dd>
                    
                    <dt class="col-sm-7">Koszt materiałów:</dt>
                    <dd class="col-sm-5 text-right">{{ "%.2f"|format(cost_details.material_cost) }} zł</dd>
                    
                    <dt class="col-sm-7">Koszt produkcji:</dt>
                    <dd class="col-sm-5 text-right">{{ "%.2f"|format(cost_details.production_cost) }} zł</dd>
                    
                    <dt class="col-sm-7 border-top pt-2 mt-2"><strong>RAZEM:</strong></dt>
                    <dd class="col-sm-5 text-right border-top pt-2 mt-2"><strong>{{ "%.2f"|format(cost_details.total_cost) }} zł</strong></dd>
                </dl>
            </div>
        </div>
        </div>
</div>

{% endblock %}