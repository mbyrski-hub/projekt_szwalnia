<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Krojownia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="manifest" href="{{ url_for('static', filename='mobile_assets/manifest_krojownia.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='mobile_assets/icon_krojownia_192.png') }}">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #333;
            overscroll-behavior: contain;
            user-select: none;
            -webkit-user-select: none;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .unassigned-container {
            flex-shrink: 0; padding: 8px; background-color: #444; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;
        }
        .column-header {
            padding: 5px; font-weight: bold; font-size: 1.1em; color: #fff; text-align: center;
        }
        .unassigned-items {
            display: flex; overflow-x: auto; padding-bottom: 10px; gap: 8px;
        }
        .item {
            background-color: #ffffff; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab;
            touch-action: none; flex-shrink: 0; width: 180px; position: relative;
        }
        .item.dragging { opacity: 0.5; }
        .item-code { font-weight: bold; font-size: 1.1em; }
        .item-client { color: #555; font-size: 0.9em; margin-top: 4px; }
        
        .main-container {
            flex-grow: 1; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; overflow-y: auto;
        }
        .column {
            border-radius: 10px; padding: 10px; display: flex; flex-direction: column; flex-grow: 1; flex-basis: calc(50% - 12px); 
        }
        .column .column-header {
            border-bottom: 2px solid rgba(255,255,255,0.2); margin-bottom: 10px;
        }
        .column-items {
            flex-grow: 1; overflow-y: auto; min-height: 100px;
        }

        #stol-1 { background-color: #3498db; }
        #stol-2 { background-color: #2ecc71; }
        #stol-3 { background-color: #f1c40f; }
        #skrojone { background-color: #e74c3c; }

        #refresh-btn {
            position: fixed; top: 15px; right: 15px; font-size: 24px; color: #fff; cursor: pointer; z-index: 1000;
        }
        
        #notification-container {
            position: fixed; top: 0; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 500px; padding-top: 10px;
        }
        .notification {
            padding: 12px 15px; border-radius: 8px; color: #fff; margin-bottom: 10px; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); animation: fadeInDown 0.5s forwards;
        }
        .notification.success { background-color: #4CAF50; }
        .notification.error { background-color: #F44336; }
        @keyframes fadeInDown { to { opacity: 1; transform: translateY(0); } }

        /* --- NOWE STYLE DLA OKNA MODALNEGO --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h4 { margin: 0; }
        .modal-close { font-size: 24px; cursor: pointer; border: none; background: none; }
        .modal-body ul { padding-left: 20px; }
    </style>
</head>
<body>
    
    <div id="notification-container"></div>
    <i id="refresh-btn" class="fas fa-sync-alt" onclick="location.reload();"></i>

    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modal-title">Szczegóły Zlecenia</h4>
                <button id="modal-close-btn" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                </div>
        </div>
    </div>

    <div class="unassigned-container">
        <div class="column-header">Nowe</div>
        <div class="unassigned-items" id="unassigned-items-container" data-table-id="unassigned"></div>
    </div>
    <div class="main-container">
        <div class="column" id="stol-1" data-table-id="stol-1"><div class="column-header">Stół 1</div><div class="column-items"></div></div>
        <div class="column" id="stol-2" data-table-id="stol-2"><div class="column-header">Stół 2</div><div class="column-items"></div></div>
        <div class="column" id="stol-3" data-table-id="stol-3"><div class="column-header">Stół 3</div><div class="column-items"></div></div>
        <div class="column" id="skrojone" data-table-id="skrojone"><div class="column-header">Skrojone</div><div class="column-items"></div></div>
    </div>

    <script>
        const notificationContainer = document.getElementById('notification-container');
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        
        // Zamykanie okna modalnego
        document.getElementById('modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            notificationContainer.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        // --- NOWA FUNKCJA DO POKAZYWANIA SZCZEGÓŁÓW ---
        function showOrderDetails(orderId) {
            fetch(`/api/order/${orderId}/details`)
                .then(res => res.json())
                .then(data => {
                    modalTitle.textContent = `Szczegóły: ${data.order_code}`;
                    let productsHtml = data.products.map(p => `<li>${p.name} (${p.size}): <b>${p.quantity} szt.</b></li>`).join('');
                    let fabricsHtml = data.fabrics.map(f => `<li>${f}</li>`).join('');

                    modalBody.innerHTML = `
                        <p><strong>Klient:</strong> ${data.client_name}</p>
                        <p><strong>Termin:</strong> ${data.deadline}</p>
                        <hr>
                        <p><strong>Opis:</strong><br>${data.description.replace(/\n/g, '<br>')}</p>
                        <hr>
                        <h5>Tkaniny</h5>
                        <ul>${fabricsHtml || '<li>Brak</li>'}</ul>
                        <h5>Produkty</h5>
                        <ul>${productsHtml || '<li>Brak</li>'}</ul>
                    `;
                    modal.style.display = 'flex';
                })
                .catch(() => showNotification('Błąd pobierania szczegółów.', 'error'));
        }

        function createOrderElement(order) {
            const item = document.createElement('div');
            item.className = 'item';
            item.dataset.orderId = order.id;
            item.draggable = true;
            item.innerHTML = `<div class="item-code">${order.order_code}</div><div class="item-client">${order.client_name}</div>`;
            return item;
        }

        function loadOrders() {
            fetch('/api/krojownia/orders')
                .then(response => response.json())
                .then(orders => {
                    document.querySelectorAll('.column-items, .unassigned-items').forEach(c => c.innerHTML = '');
                    orders.forEach(order => {
                        const item = createOrderElement(order);
                        if (order.cutting_table) {
                            document.querySelector(`#${order.cutting_table} .column-items`).appendChild(item);
                        } else {
                            document.getElementById('unassigned-items-container').appendChild(item);
                        }
                    });
                    setupDragAndDrop();
                })
                .catch(error => { showNotification('Błąd ładowania zleceń.', 'error'); });
        }

        function setupDragAndDrop() {
            const items = document.querySelectorAll('.item');
            const dropzones = document.querySelectorAll('.column-items, .unassigned-items');
            let draggedItem = null;
            let clickTimer = null;

            items.forEach(item => {
                item.addEventListener('dragstart', () => {
                    // Anuluj kliknięcie, jeśli rozpoczyna się przeciąganie
                    clearTimeout(clickTimer); 
                    draggedItem = item;
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', () => {
                    if (draggedItem) draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });

                // Zdarzenia dotykowe do obsługi kliknięcia
                item.addEventListener('touchstart', () => {
                    clickTimer = setTimeout(() => {
                        clickTimer = null; // Resetuj timer, aby nie wywołać podwójnie
                    }, 200); // Czas w ms na odróżnienie od przeciągania
                }, { passive: true });

                item.addEventListener('touchend', () => {
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                        showOrderDetails(item.dataset.orderId);
                    }
                });

                // Zwykłe kliknięcie dla myszy
                item.addEventListener('click', () => {
                     showOrderDetails(item.dataset.orderId);
                });
            });

            dropzones.forEach(zone => {
                zone.addEventListener('dragover', e => e.preventDefault());
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    if (!draggedItem) return;
                    
                    const fromZone = draggedItem.parentElement;
                    const toZone = e.currentTarget;

                    if (fromZone !== toZone) {
                        const originalParent = draggedItem.parentElement;
                        toZone.appendChild(draggedItem);

                        const orderId = draggedItem.dataset.orderId;
                        const newTableId = toZone.parentElement.dataset.tableId || toZone.dataset.tableId;

                        fetch(`/api/order/${orderId}/assign_table`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ table: newTableId === 'unassigned' ? null : newTableId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                originalParent.appendChild(draggedItem);
                                showNotification('Błąd aktualizacji.', 'error');
                            } else {
                                showNotification(data.message || 'Zaktualizowano!', 'success');
                            }
                        })
                        .catch(() => {
                            originalParent.appendChild(draggedItem);
                            showNotification('Błąd połączenia.', 'error');
                        });
                    }
                });
            });
        }
        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>
</html>