{% extends "base.html" %}
{% block title %}Kalkulator Kosztów{% endblock %}

{% block head %}
<style>
    .result-box {
        background-color: #e9ecef;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
    }
    .result-box h3 {
        margin-top: 0;
        color: #0056b3;
    }
    .result-box #finalPrice {
        font-size: 2.5rem;
        font-weight: 700;
        color: #28a745;
    }
    /* NOWA REGUŁA */
    .result-box strong {
        font-size: 1.1rem; /* Lekko powiększamy czcionkę */
        display: inline-block; /* Dodajemy, aby margines zadziałał */
        margin-top: 5px; /* Mały odstęp od górnej linii */
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-calculator"></i> Kalkulator Kosztów Produktu</h2>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">Krok 1: Wybierz Produkt (lub wpisz własne dane)</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="categoryFilter">Filtruj po kategorii:</label>
                    <select id="categoryFilter" class="form-control form-control-sm mb-2">
                        <option value="all">-- Pokaż wszystkie --</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="productSelector">Wybierz istniejący produkt, aby wczytać jego dane:</label>
                    <select id="productSelector" class="form-control">
                        <option value="custom">-- Produkt niestandardowy --</option>
                        </select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Krok 2: Składniki i Koszty</div>
            <div class="card-body">
                <h5><i class="fas fa-scroll"></i> Tkaniny</h5>
                <div id="fabrics-list">
                    </div>
                <button type="button" class="btn btn-sm btn-secondary mt-2" id="add-fabric-btn"><i class="fas fa-plus"></i> Dodaj tkaninę</button>
                <hr>
                
                <h5><i class="fas fa-cogs"></i> Materiały Dodatkowe</h5>
                <div id="materials-list">
                    </div>
                <button type="button" class="btn btn-sm btn-secondary mt-2" id="add-material-btn"><i class="fas fa-plus"></i> Dodaj materiał</button>
                <hr>
                
                <h5><i class="fas fa-euro-sign"></i> Koszty Produkcji</h5>
                <div class="form-group">
                    <label for="productionPrice">Cena Produkcji (robocizna) [zł]</label>
                    <input type="number" id="productionPrice" class="form-control calc-input" value="0.0" step="0.01">
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Krok 3: Marża i Wynik</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="marginInput">Marża [%]</label>
                    <input type="number" id="marginInput" class="form-control calc-input" value="0" step="1">
                </div>
                <div class="result-box mt-3">
                    <h3>Sugerowana Cena Sprzedaży Netto</h3>
                    <span id="finalPrice">0.00 zł</span>
                    <hr>
                    <small class="text-muted">
                        Koszt tkaniny: <span id="fabricCost">0.00 zł</span><br>
                        Koszt materiałów: <span id="materialsCost">0.00 zł</span><br>
                        Koszt produkcji: <span id="prodCost">0.00 zł</span><br>
                        <strong>Koszt całkowity: <span id="totalCost">0.00 zł</span></strong>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="fabric-row-template">
    <div class="form-row align-items-center mb-2 fabric-row">
        <div class="col-7">
            <select class="form-control calc-input fabric-select">
                <option value="0" data-price="0.0">-- Wybierz tkaninę --</option>
                {% for fabric in fabrics %}
                <option value="{{ fabric.id }}" data-price="{{ fabric.price or 0.0 }}">{{ fabric.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-3">
            <input type="number" class="form-control calc-input fabric-usage" placeholder="Zużycie [m]" value="0.0" step="0.01">
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-danger btn-sm remove-fabric-btn"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</template>

<template id="material-row-template">
    <div class="form-row align-items-center mb-2 material-row">
        <div class="col-7">
            <select class="form-control calc-input material-select">
                <option value="0" data-price="0.0">-- Wybierz materiał --</option>
                {% for material in materials %}
                <option value="{{ material.id }}" data-price="{{ material.price or 0.0 }}">{{ material.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-3">
            <input type="text" class="form-control calc-input material-quantity" placeholder="Ilość" value="1">
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-danger btn-sm remove-material-btn"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</template>

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- BAZA WIEDZY ---
    const productsData = JSON.parse('{{ products_json|safe }}');

    // --- ELEMENTY DOM ---
    const categoryFilter = document.getElementById('categoryFilter');
    const productSelector = document.getElementById('productSelector');
    const productionPrice = document.getElementById('productionPrice');
    const marginInput = document.getElementById('marginInput');
    const fabricsList = document.getElementById('fabrics-list');
    const addFabricBtn = document.getElementById('add-fabric-btn');
    const fabricRowTemplate = document.getElementById('fabric-row-template');
    const materialsList = document.getElementById('materials-list');
    const addMaterialBtn = document.getElementById('add-material-btn');
    const materialRowTemplate = document.getElementById('material-row-template');
    const finalPriceEl = document.getElementById('finalPrice');
    const fabricCostEl = document.getElementById('fabricCost');
    const materialsCostEl = document.getElementById('materialsCost');
    const prodCostEl = document.getElementById('prodCost');
    const totalCostEl = document.getElementById('totalCost');

    // --- GŁÓWNA FUNKCJA OBLICZENIOWA ---
    function calculate() {
        let fabricCost = 0;
        document.querySelectorAll('.fabric-row').forEach(row => {
            const select = row.querySelector('.fabric-select');
            const usageInput = row.querySelector('.fabric-usage');
            const selectedFabricOption = select.options[select.selectedIndex];
            const fabricPrice = parseFloat(selectedFabricOption.dataset.price);
            const fabricAmount = parseFloat(usageInput.value) || 0;
            fabricCost += fabricPrice * fabricAmount;
        });

        let materialsCost = 0;
        document.querySelectorAll('.material-row').forEach(row => {
            const select = row.querySelector('.material-select');
            const quantityInput = row.querySelector('.material-quantity');
            const selectedMaterialOption = select.options[select.selectedIndex];
            const materialPrice = parseFloat(selectedMaterialOption.dataset.price);
            const quantityMatch = (String(quantityInput.value).match(/(\d+\.?\d*)/) || [0, 0]);
            const materialAmount = parseFloat(quantityMatch[1]);
            materialsCost += materialPrice * materialAmount;
        });

        const prodPrice = parseFloat(productionPrice.value) || 0;
        const totalCost = fabricCost + materialsCost + prodPrice;
        const margin = parseFloat(marginInput.value) || 0;
        const finalPrice = totalCost * (1 + margin / 100);

        fabricCostEl.textContent = `${fabricCost.toFixed(2)} zł`;
        materialsCostEl.textContent = `${materialsCost.toFixed(2)} zł`;
        prodCostEl.textContent = `${prodPrice.toFixed(2)} zł`;
        totalCostEl.textContent = `${totalCost.toFixed(2)} zł`;
        finalPriceEl.textContent = `${finalPrice.toFixed(2)} zł`;
    }

    // --- FUNKCJE POMOCNICZE ---
    function addFabricRow(fabricId = null, usage = '0.0') {
        const newRow = fabricRowTemplate.content.cloneNode(true);
        if (fabricId) newRow.querySelector('.fabric-select').value = fabricId;
        newRow.querySelector('.fabric-usage').value = usage;
        fabricsList.appendChild(newRow);
    }

    function addMaterialRow(materialId = null, quantity = '1') {
        const newRow = materialRowTemplate.content.cloneNode(true);
        if (materialId) newRow.querySelector('.material-select').value = materialId;
        newRow.querySelector('.material-quantity').value = quantity;
        materialsList.appendChild(newRow);
    }

    function updateProductSelector(selectedCategoryId) {
        const previouslySelected = productSelector.value;
        productSelector.innerHTML = '<option value="custom">-- Produkt niestandardowy --</option>';
        
        const filteredProducts = Object.entries(productsData).filter(([id, product]) => {
            return selectedCategoryId === 'all' || String(product.category_id) === String(selectedCategoryId);
        });

        filteredProducts.forEach(([id, product]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = product.name;
            productSelector.appendChild(option);
        });
        
        productSelector.value = previouslySelected;
    }

    // --- OBSŁUGA ZDARZEŃ ---
    productSelector.addEventListener('change', function() {
        const productId = this.value;
        fabricsList.innerHTML = '';
        materialsList.innerHTML = '';

        if (productId === 'custom') {
            productionPrice.value = "0.0";
            addFabricRow();
        } else {
            const data = productsData[productId];
            productionPrice.value = data.production_price || 0.0;
            addFabricRow(null, data.fabric_usage);
            data.materials_needed.forEach(material => addMaterialRow(material.id, material.quantity));
        }
        calculate();
    });

    categoryFilter.addEventListener('change', function() {
        updateProductSelector(this.value);
    });

    addFabricBtn.addEventListener('click', () => addFabricRow());
    fabricsList.addEventListener('click', e => {
        if (e.target.closest('.remove-fabric-btn')) {
            e.target.closest('.fabric-row').remove();
            calculate();
        }
    });

    addMaterialBtn.addEventListener('click', () => addMaterialRow());
    materialsList.addEventListener('click', e => {
        if (e.target.closest('.remove-material-btn')) {
            e.target.closest('.material-row').remove();
            calculate();
        }
    });
    
    document.body.addEventListener('input', e => {
        if (e.target.classList.contains('calc-input')) calculate();
    });
    document.body.addEventListener('change', e => {
        if (e.target.classList.contains('calc-input')) calculate();
    });
    
    // --- INICJALIZACJA ---
    updateProductSelector('all');
    addFabricRow();
    calculate();
});
</script>
{% endblock %}